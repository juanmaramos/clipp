name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      # Uncomment when you have Apple Developer account for code signing
      # - name: Import Code Signing Certificate
      #   if: ${{ secrets.BUILD_CERTIFICATE_BASE64 != '' }}
      #   env:
      #     CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
      #     P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      #     KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      #   run: |
      #     # Create temporary keychain
      #     security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
      #     security default-keychain -s build.keychain
      #     security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
      #     security set-keychain-settings -lut 21600 build.keychain
      #
      #     # Import certificate
      #     echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
      #     security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
      #     security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
      #
      #     # Cleanup
      #     rm certificate.p12

      - name: Build Clipp
        run: |
          xcodebuild \
            -project Maccy.xcodeproj \
            -scheme Maccy \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build

          echo "âœ… Build completed"
          ls -lh build/Build/Products/Release/

      # Uncomment when you have notarization credentials
      # - name: Code Sign and Notarize
      #   if: ${{ secrets.APPLE_ID != '' }}
      #   env:
      #     APPLE_ID: ${{ secrets.APPLE_ID }}
      #     APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
      #     TEAM_ID: ${{ secrets.TEAM_ID }}
      #   run: |
      #     APP_PATH="build/Build/Products/Release/Clipp.app"
      #
      #     # Code sign
      #     codesign --force --deep --sign "Developer ID Application" "$APP_PATH"
      #
      #     # Create zip for notarization
      #     ditto -c -k --keepParent "$APP_PATH" Clipp-notarize.zip
      #
      #     # Submit for notarization
      #     xcrun notarytool submit Clipp-notarize.zip \
      #       --apple-id "$APPLE_ID" \
      #       --password "$APPLE_ID_PASSWORD" \
      #       --team-id "$TEAM_ID" \
      #       --wait
      #
      #     # Staple notarization ticket
      #     xcrun stapler staple "$APP_PATH"
      #
      #     rm Clipp-notarize.zip

      - name: Create Distribution Package
        run: |
          cd build/Build/Products/Release

          # Rename app from Maccy to Clipp
          mv Maccy.app Clipp.app

          # Create a clean zip
          ditto -c -k --sequesterRsrc --keepParent Clipp.app $GITHUB_WORKSPACE/Clipp.zip

          cd $GITHUB_WORKSPACE

          # Get version from tag or use "dev"
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ðŸ“¦ Created Clipp.zip (Version: $VERSION)"

          # Calculate checksum
          shasum -a 256 Clipp.zip > Clipp.zip.sha256

          ls -lh Clipp.zip
          cat Clipp.zip.sha256

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Clipp-${{ env.VERSION }}
          path: |
            Clipp.zip
            Clipp.zip.sha256
          retention-days: 30

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Clipp.zip
            Clipp.zip.sha256
          body: |
            ## Clipp ${{ env.VERSION }}

            Download `Clipp.zip`, extract, and move to Applications folder.

            ### First Time Installation

            Since this app is not notarized, you need to:
            1. **Right-click** on Clipp.app
            2. Select **"Open"**
            3. Click **"Open"** in the dialog

            After the first launch, you can open it normally.

            ### SHA-256 Checksum

            ```
            $(cat Clipp.zip.sha256)
            ```

            ### Changes

            See [CHANGELOG.md](https://github.com/juanmaramos/clipp/blob/master/CHANGELOG.md) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          # Delete temporary keychain if it was created
          security delete-keychain build.keychain 2>/dev/null || true
